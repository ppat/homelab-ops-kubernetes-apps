---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: promtail-release
  namespace: logging
spec:
  chart:
    spec:
      chart: promtail
      interval: 24h0m0s
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: grafana-repository
        namespace: flux-system
      version: 6.16.6
  install:
    crds: CreateReplace
    createNamespace: false
    remediation:
      retries: 3
  interval: 15m0s
  releaseName: promtail
  targetNamespace: logging
  upgrade:
    crds: CreateReplace
    cleanupOnFail: true
    remediation:
      ignoreTestFailures: false
      retries: 3
      strategy: rollback

  valuesFrom:
  - kind: ConfigMap
    name: promtail-default-config
    valuesKey: default-scrape-config.yaml
    optional: false
  - kind: ConfigMap
    name: promtail-default-config
    valuesKey: default-volumes.yaml
    optional: false
  - kind: ConfigMap
    name: promtail-extra-config
    valuesKey: extra-limits-config.yaml
    optional: true
  - kind: ConfigMap
    name: promtail-extra-config
    valuesKey: extra-relabel-config.yaml
    optional: true
  - kind: ConfigMap
    name: promtail-extra-config
    valuesKey: extra-scrape-config.yaml
    optional: true
  - kind: ConfigMap
    name: promtail-extra-config
    valuesKey: extra-server-config.yaml
    optional: true
  - kind: ConfigMap
    name: promtail-extra-config
    valuesKey: extra-volumes.yaml
    optional: true

  values:
    configmap:
      enabled: true
    daemonset:
      enabled: true
    extraArgs:
    - -client.external-labels=host=$(HOSTNAME)
    # -- Configure additional ports and services. For each configured port, a corresponding service is created.
    # See values.yaml for details
    extraPorts: {}
    #  syslog:
    #    name: tcp-syslog
    #    annotations: {}
    #    labels: {}
    #    containerPort: 1514
    #    protocol: TCP
    #    service:
    #      type: ClusterIP
    #      clusterIP: null
    #      port: 1514
    #      externalIPs: []
    #      nodePort: null
    #      loadBalancerIP: null
    #      loadBalancerSourceRanges: []
    #      externalTrafficPolicy: null
    #    ingress:
    #      annotations: {}
    #        # kubernetes.io/ingress.class: nginx
    #        # kubernetes.io/tls-acme: "true"
    #      paths: "/"
    #      hosts:
    #        - chart-example.local
    #
    #      tls: []
    #      #  - secretName: chart-example-tls
    #      #    hosts:
    #      #      - chart-example.local

    config:
      enabled: true
      clients:
      - url: http://loki-gateway.logging.svc.cluster.local./loki/api/v1/push

    resources: {}
    tolerations:
    - key: node-role.kubernetes.io/master
      operator: Exists
    - key: node-role.kubernetes.io/control-plane
      operator: Exists

    serviceMonitor:
      enabled: true
      annotations: {}
      labels: {}
      prometheusRule:
        enabled: false
