---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: promtail-release
  namespace: logging
spec:
  chart:
    spec:
      chart: promtail
      interval: 24h0m0s
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: grafana-repository
        namespace: flux-system
      version: 6.16.6
  install:
    crds: CreateReplace
    createNamespace: false
    remediation:
      retries: 3
  interval: 15m0s
  releaseName: promtail
  targetNamespace: logging
  upgrade:
    crds: CreateReplace
    cleanupOnFail: true
    remediation:
      ignoreTestFailures: false
      retries: 3
      strategy: rollback
  values:
    daemonset:
      enabled: true

    resources: {}
    tolerations:
    - key: node-role.kubernetes.io/master
      operator: Exists
    - key: node-role.kubernetes.io/control-plane
      operator: Exists

    extraVolumes:
    # /etc/machine-id needed for reading systemd journal logs
    - name: etc-machineid
      hostPath:
        path: /etc/machine-id
    - name: run-log-journal
      hostPath:
        path: /run/log/journal
    - name: var-log-journal
      hostPath:
        path: /var/log/journal
    - name: var-log
      hostPath:
        path: /var/log

    extraVolumeMounts:
    - mountPath: /etc/machine-id
      name: etc-machineid
      readOnly: true
    - mountPath: /run/log/journal
      name: run-log-journal
      readOnly: true
    - mountPath: /var/log/journal
      name: var-log-journal
      readOnly: true
    - mountPath: /var/log/dmesg
      name: var-log
      readOnly: true
      subPath: dmesg
    - mountPath: /var/log/cloud-init.log
      name: var-log
      readOnly: true
      subPath: cloud-init.log
    - mountPath: /var/log/cloud-init-output.log
      name: var-log
      readOnly: true
      subPath: cloud-init-output.log
    - mountPath: /var/log/pihole
      name: var-log
      readOnly: true
      subPath: pihole
    - mountPath: /var/log/traefik
      name: var-log
      readOnly: true
      subPath: traefik
    - mountPath: /var/log/unifi
      name: var-log
      readOnly: true
      subPath: unifi

    # Extra args for the Promtail container.
    extraArgs:
    - -client.external-labels=host=$(HOSTNAME)

    serviceMonitor:
      enabled: true
      annotations: {}
      labels: {}
      prometheusRule:
        enabled: false

    # -- Configure additional ports and services. For each configured port, a corresponding service is created.
    # See values.yaml for details
    extraPorts: {}
    #  syslog:
    #    name: tcp-syslog
    #    annotations: {}
    #    labels: {}
    #    containerPort: 1514
    #    protocol: TCP
    #    service:
    #      type: ClusterIP
    #      clusterIP: null
    #      port: 1514
    #      externalIPs: []
    #      nodePort: null
    #      loadBalancerIP: null
    #      loadBalancerSourceRanges: []
    #      externalTrafficPolicy: null
    #    ingress:
    #      annotations: {}
    #        # kubernetes.io/ingress.class: nginx
    #        # kubernetes.io/tls-acme: "true"
    #      paths: "/"
    #      hosts:
    #        - chart-example.local
    #
    #      tls: []
    #      #  - secretName: chart-example-tls
    #      #    hosts:
    #      #      - chart-example.local

    config:
      enabled: true
      clients:
      - url: http://loki-gateway.logging.svc.cluster.local./loki/api/v1/push

      # Custom snippets may be added in order to reduce redundancy.
      # This is especially helpful when multiple `kubernetes_sd_configs` are use which usually have
      # large parts in common.
      snippets:
        # If set to true, adds an additional label for the scrape job.
        # This helps debug the Promtail config.
        addScrapeJobLabel: false

        # -- You can put here any keys that will be directly added to the config file's 'limits_config' block.
        extraLimitsConfig: ""

        # -- You can put here any keys that will be directly added to the config file's 'server' block.
        extraServerConfigs: ""

        # -- You can put here any additional scrape configs you want to add to the config file.
        # yamllint disable-line rule:indentation
        extraScrapeConfigs: |-
          - job_name: journal
            journal:
              path: /run/log/journal
              max_age: 12h
              labels:
                job: systemd-journal
            relabel_configs:
            - source_labels:
              - __journal__systemd_unit
              target_label: systemd_unit
            - source_labels:
              - __journal_syslog_identifier
              target_label: syslog_identifier
            - source_labels:
              - __journal_priority_keyword
              target_label: severity
          - job_name: journal
            journal:
              path: /var/log/journal
              max_age: 12h
              labels:
                job: systemd-journal
            relabel_configs:
            - source_labels:
              - __journal__systemd_unit
              target_label: systemd_unit
            - source_labels:
              - __journal_syslog_identifier
              target_label: syslog_identifier
            - source_labels:
              - __journal_priority_keyword
              target_label: severity

          - job_name: system
            static_configs:
            - targets:
              - localhost
              labels:
                service_name: dmesg
                __path__: /var/log/dmesg
            - targets:
              - localhost
              labels:
                service_name: cloud-init
                __path__: /var/log/cloud-init-output.log
            - targets:
              - localhost
              labels:
                service_name: cloud-init
                __path__: /var/log/cloud-init.log

          - job_name: pihole-dnsmasq-logs
            static_configs:
            - targets:
              - localhost
              labels:
                app: pihole
                container: pihole
                __path__: /var/log/pihole/pihole.log
            # pipeline_stages:
            # - regex:
            #     expression: '^(?P<time>\w{3} +\d{1,2} \d{2}:\d{2}:\d{2}) .*'
            # - timestamp:
            #     source: time
            #     # format specified using reference timestamp: Mon Jan 2 15:04:05 -0700 MST 2006
            #     # see: https://grafana.com/docs/loki/latest/send-data/promtail/stages/timestamp/
            #     format: 'Jan _2 15:04:05'

          - job_name: pihole-ftl-logs
            static_configs:
            - targets:
              - localhost
              labels:
                app: pihole
                container: pihole
                __path__: /var/log/pihole/FTL.log
            # pipeline_stages:
            # - regex:
            #     expression: '^\[(?P<time>[^\]]+)\s+(?P<metadata>[^\]]+)\] .*'
            # - timestamp:
            #     source: time
            #     # format specified using reference timestamp: Mon Jan 2 15:04:05 -0700 MST 2006
            #     # see: https://grafana.com/docs/loki/latest/send-data/promtail/stages/timestamp/
            #     format: '2006-01-02 15:04:05.000'

          - job_name: pihole-gravity-logs
            static_configs:
            - targets:
              - localhost
              labels:
                app: pihole
                container: pihole
                __path__: /var/log/pihole/pihole_updateGravity.log

          - job_name: traefik-access-logs
            static_configs:
            - targets:
              - localhost
              labels:
                app: traefik
                container: traefik
                __path__: /var/log/traefik/*.log
            pipeline_stages:
            - json:
                expressions:
                  timestamp: time
                  status: DownstreamStatus
                  method: RequestMethod
                drop_malformed: true
            - labels:
                status:
                method:
            - timestamp:
                source: timestamp
                format: RFC3339

          - job_name: unifi-logs
            static_configs:
            - targets:
              - localhost
              labels:
                app: unifi-network-application
                container: unifi
                __path__: /var/log/unifi/*.log

        # -- You can put here any additional relabel_configs to "kubernetes-pods" job
        extraRelabelConfigs: []
