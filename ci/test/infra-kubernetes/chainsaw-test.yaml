---
# Main test file for infrastructure kubernetes modules
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: infra-kubernetes
spec:
  # bindings:
  # - name: test_path
  #   value: ./ci/test/infra-kubernetes
  steps:
  - name: Bootstrap FluxCD
    use:
      template: ../chainsaw/steps/bootstrap-flux.yaml
      with:
        bindings:
        - name: test_path
          value: ./ci/test/infra-kubernetes

  - name: Test infra-kubernetes-core module
    try:
    - description: Reconcile kustomization/infra-kubernetes-core
      script:
        content: ../chainsaw/scripts/flux-reconcile.sh --resource-type=kustomization  --resource-name=infra-kubernetes-core --timeout=3m
    - description: Assert configmap/coredns-custom
      assert:
        resource:
          apiVersion: v1
          kind: ConfigMap        
          metadata:
            name: coredns-custom
            namespace: kube-system
    - description: Assert deployment/coredns
      assert:
        bindings:
        - name: deployment_name
          value: coredns
        - name: deployment_namespace
          value: kube-system
        file: ../chainsaw/assertions/deployment-ready.yaml
    - description: Assert ingress/kubernetes-api
      assert:
        resource:
          apiVersion: networking.k8s.io/v1
          kind: Ingress        
          metadata:
            name: kubernetes-api
            namespace: default
    finally:
    - describe:
        apiVersion: apps/v1
        kind: Deployment
        name: coredns
        namespace: kube-system
    - podLogs:
        name: coredns
        namespace: kube-system
    - events:
        namespace: kube-system

  - name: Test infra-kubernetes-extra module
    try:
    - description: Reconcile infra-kubernetes-extra
      script:
        content: ../chainsaw/scripts/flux-reconcile.sh --resource-type=kustomization --resource-name=infra-kubernetes-extra --timeout=3m
    # Wait for NFD components
    - wait:
        apiVersion: apps/v1
        kind: Deployment
        name: ($values.resources.nfd.master)
        namespace: ($values.namespaces.core)
        timeout: 1m
        for:
          condition:
            name: Available
            value: "true"
    - assert:
        bindings:
          - name: name
            value: ($values.resources.nfd.worker)
          - name: namespace
            value: ($values.namespaces.core)
        file: ../chainsaw/templates/rollouts/daemonset.yaml
    - wait:
        apiVersion: apps/v1
        kind: Deployment
        name: ($values.resources.nfd.gc)
        namespace: ($values.namespaces.core)
        timeout: 1m
        for:
          condition:
            name: Available
            value: "true"
    # Wait for VPA
    - wait:
        apiVersion: apps/v1
        kind: Deployment
        name: ($values.resources.vpa.recommender)
        namespace: ($values.namespaces.core)
        timeout: 1m
        for:
          condition:
            name: Available
            value: "true"
    # Wait for Device Plugins
    - wait:
        apiVersion: apps/v1
        kind: Deployment
        name: ($values.resources.plugins.operator)
        namespace: ($values.namespaces.intel)
        timeout: 1m
        for:
          condition:
            name: Available
            value: "true"
    - wait:
        apiVersion: apps/v1
        kind: Deployment
        name: ($values.resources.plugins.gpu)
        namespace: ($values.namespaces.intel)
        timeout: 1m
        for:
          condition:
            name: Available
            value: "true"
    - assert:
        bindings:
          - name: name
            value: ($values.resources.plugins.generic)
          - name: namespace
            value: ($values.namespaces.core)
        file: ../chainsaw/templates/rollouts/daemonset.yaml
    # Wait for Descheduler
    - wait:
        apiVersion: apps/v1
        kind: Deployment
        name: ($values.resources.descheduler.deployment)
        namespace: ($values.namespaces.core)
        timeout: 1m
        for:
          condition:
            name: Available
            value: "true"
    finally:
    # Debug extra issues if failed
    - describe:
        apiVersion: apps/v1
        kind: DaemonSet
        name: ($values.resources.nfd.worker)
        namespace: ($values.namespaces.core)
    - podLogs:
        name: ($values.resources.nfd.worker)
        namespace: ($values.namespaces.core)
    # Clean up git source
    - delete:
        ref:
          apiVersion: source.toolkit.fluxcd.io/v1
          kind: GitRepository
          name: test-source
          namespace: ($values.namespaces.flux)
